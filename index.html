<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozy Cover Trading Exchange</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #121212; 
            color: #e0e0e0; 
            text-align: center; 
            margin: 0;
            padding: 20px;
        }
        h1 { color: #f1c40f; letter-spacing: 2px; text-transform: uppercase; }
        p { color: #aaa; }

        .container { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 20px; 
            margin-top: 30px; 
        }

        .card { 
            background: #1e1e1e; 
            border: 1px solid #333; 
            padding: 20px; 
            width: 320px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-5px); border-color: #555; }

        h3 { margin-top: 0; font-size: 1.2em; color: #fff; }

        .price-box {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price { font-size: 28px; font-weight: bold; color: #fff; }
        .mrp { font-size: 14px; color: #777; text-decoration: line-through; }

        canvas { 
            max-width: 100%; 
            height: 150px !important; 
            margin-bottom: 15px; 
            background: #181818;
            border-radius: 5px;
        }

        button { 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
            color: white; 
            border: none; 
            padding: 12px; 
            width: 100%; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold;
            border-radius: 8px; 
            transition: 0.3s;
        }
        button:hover { background: linear-gradient(135deg, #219150, #27ae60); box-shadow: 0 0 10px #2ecc71; }
        button:active { transform: scale(0.98); }

    </style>
</head>
<body>

    <h1>üìâ COZY COVER LIVE EXCHANGE üìà</h1>
    <p>Market Status: <span style="color:#2ecc71">‚óè LIVE</span> | Updates every 5 seconds</p>

    <div id="market" class="container">
        <h2>Connecting to Market...</h2>
    </div>

    <script>
        const charts = {};

        // 1. INITIALIZE THE MARKET
        async function initMarket() {
            try {
                // NOTICE: No "http://localhost:3000" anymore! just "/api/products"
                const response = await fetch('/api/products');
                const products = await response.json();
                const marketDiv = document.getElementById('market');
                marketDiv.innerHTML = ''; 

                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${product.name}</h3>
                        <div class="price-box">
                            <div>
                                <div class="mrp">MRP ‚Çπ${product.mrp}</div>
                                <div class="price" id="price-${product.id}">‚Çπ${product.current_price}</div>
                            </div>
                        </div>
                        <canvas id="chart-${product.id}"></canvas>
                        <button onclick="buyProduct(${product.id}, '${product.name}')">BUY NOW</button>
                    `;
                    marketDiv.appendChild(card);

                    const ctx = document.getElementById(`chart-${product.id}`).getContext('2d');
                    charts[product.id] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [], 
                            datasets: [{
                                label: 'Price History',
                                data: [], 
                                borderColor: '#f1c40f',
                                borderWidth: 2,
                                pointRadius: 0, 
                                tension: 0.4,   
                                fill: true,
                                backgroundColor: 'rgba(241, 196, 15, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                x: { display: false }, 
                                y: { display: true, grid: { color: '#333' } } 
                            },
                            animation: false 
                        }
                    });
                });

                setInterval(updateData, 3000);
                
            } catch (err) {
                console.error("Server connection failed:", err);
                document.getElementById('market').innerHTML = "<h2 style='color:red'>‚ùå Connection Failed.</h2>";
            }
        }

        // 2. LIVE UPDATE LOOP
        async function updateData() {
            try {
                const response = await fetch('/api/products');
                const products = await response.json();

                for (let product of products) {
                    const priceElement = document.getElementById(`price-${product.id}`);
                    priceElement.innerText = `‚Çπ${product.current_price}`;

                    const historyRes = await fetch(`/api/history/${product.id}`);
                    const history = await historyRes.json();

                    const chart = charts[product.id];
                    if (chart && history.length > 0) {
                        chart.data.labels = history.map(h => h.recorded_at); 
                        chart.data.datasets[0].data = history.map(h => h.new_price); 
                        
                        const currentPrice = history[history.length - 1].new_price;
                        const prevPrice = history.length > 1 ? history[history.length - 2].new_price : currentPrice;
                        
                        const color = currentPrice >= prevPrice ? '#2ecc71' : '#e74c3c'; 
                        chart.data.datasets[0].borderColor = color;
                        chart.data.datasets[0].backgroundColor = currentPrice >= prevPrice ? 'rgba(46, 204, 113, 0.1)' : 'rgba(231, 76, 60, 0.1)';
                        
                        chart.update();
                    }
                }
            } catch (err) {
                console.error("Update failed:", err);
            }
        }

        // 3. BUY FUNCTION
        async function buyProduct(id, name) {
            const priceText = document.getElementById(`price-${id}`).innerText;
            const cleanPrice = parseFloat(priceText.replace('‚Çπ', '')); 

            if(!confirm(`LOCK PRICE for ${name} at ‚Çπ${cleanPrice}? \n(Price might change if you wait!)`)) {
                return;
            }

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_id: id,
                        quantity: 1, 
                        locked_price: cleanPrice
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ SUCCESS! Order #${result.orderId} confirmed at ‚Çπ${cleanPrice}.`);
                } else {
                    alert("‚ùå Transaction Failed.");
                }
            } catch (err) {
                console.error(err);
                alert("Server Error. Check console.");
            }
        }

        initMarket();
    </script>
</body>
</html>